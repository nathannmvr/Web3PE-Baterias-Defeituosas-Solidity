<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Moura | Cadastro de Baterias na Blockchain</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js" defer></script>
    <style>
        :root {
            --moura-yellow: #F5AA1C;
            --moura-yellow-700: #D49012;
            --moura-blue: #4F80C7;
            --moura-deep: #3F51A6;
            --bg: #0A0B0E;
            --muted: #9AA4B2;
            --ok: #16a34a;
            --err: #dc2626;
            --radius: 18px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 15% -10%, rgba(79, 128, 199, .18), transparent 60%),
                radial-gradient(1200px 800px at 110% 10%, rgba(63, 81, 166, .18), transparent 60%), var(--bg);
            color: #E8EEF6;
            font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px clamp(16px, 4vw, 40px);
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            backdrop-filter: saturate(1.2) blur(8px);
            background: rgba(10, 11, 14, .55);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        header img.logo {
            height: 42px;
            width: auto;
            object-fit: contain
        }

        .brand {
            display: flex;
            flex-direction: column;
            line-height: 1
        }

        .brand b {
            font-size: 18px;
            letter-spacing: .5px
        }

        .brand small {
            color: var(--muted)
        }

        .spacer {
            flex: 1
        }

        .btn {
            appearance: none;
            border: 0;
            background: var(--moura-yellow);
            color: #0A0B0E;
            padding: 12px 16px;
            font-weight: 700;
            border-radius: 14px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: .2s transform, .2s background;
        }

        .btn:hover {
            background: var(--moura-yellow-700);
            transform: translateY(-1px)
        }

        .btn.secondary {
            background: linear-gradient(135deg, var(--moura-blue), var(--moura-deep));
            color: #fff
        }

        .btn.secondary:disabled {
            opacity: 0.4;
            cursor: not-allowed
        }

        .btn.ghost {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .18);
            box-shadow: none
        }

        main {
            width: min(1200px, 95%);
            margin: 28px auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px
        }

        @media (max-width:980px) {
            main {
                grid-template-columns: 1fr
            }
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, .02));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .card h2 {
            margin: 0;
            padding: 18px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, .06);
        }

        .card .content {
            padding: 18px 20px
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px
        }

        @media (max-width:700px) {
            .grid {
                grid-template-columns: 1fr
            }
        }

        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin: 6px 0
        }

        input,
        select {
            width: 100%;
            padding: 12px 14px;
            background: #0f1218;
            color: #e8eef6;
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 12px;
            outline: none;
            transition: .2s border, .2s box-shadow;
        }

        input:focus {
            border-color: var(--moura-blue);
            box-shadow: 0 0 0 3px rgba(79, 128, 199, .25)
        }

        input:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 6px;
            padding: 8px 4px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
        }

        .checkbox-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--moura-blue);
            cursor: pointer;
        }

        .checkbox-row label {
            margin: 0;
            font-size: 14px;
            color: #E8EEF6;
            cursor: pointer;
            user-select: none;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px
        }

        .result-box {
            margin-top: 14px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 14px;
            line-height: 1.5;
        }

        .result-box b {
            color: var(--moura-yellow)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 14px
        }

        th,
        td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            text-align: left
        }

        thead th {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--muted);
            background: rgba(79, 128, 199, .08)
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, .02)
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600
        }

        .chip.ok {
            background: rgba(22, 163, 74, .12);
            color: #7ee38f
        }

        .chip.off {
            background: rgba(220, 38, 38, .14);
            color: #fda4af
        }

        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            max-width: min(90vw, 420px);
            padding: 14px 16px;
            border-radius: 14px;
            background: #0f1218;
            color: #e8eef6;
            border: 1px solid rgba(255, 255, 255, .12);
            box-shadow: var(--shadow);
            display: none;
        }

        .toast.show {
            display: block
        }

        .toast.ok {
            border-color: rgba(22, 163, 74, .55)
        }

        .toast.err {
            border-color: rgba(220, 38, 38, .55)
        }

        footer {
            opacity: .75;
            padding: 20px;
            text-align: center;
            color: var(--muted)
        }
    </style>
</head>

<body>
    <header>
        <img class="logo" src="https://logodownload.org/wp-content/uploads/2017/08/moura-logo-1.png" alt="Moura">
        <div class="brand">
            <b>Cadastro de Baterias Moura</b>
            <small>Blockchain • Transparência • Rastreabilidade</small>
        </div>
        <div class="spacer"></div>
        <button id="btn-connect" class="btn">Conectar carteira</button>
        <span id="wallet-info" style="display:none; font-weight:600; color:#9AE6B4;">✅ Carteira conectada</span>
    </header>

    <main>
        <section class="card">
            <h2>Adicionar / Atualizar Bateria</h2>
            <div class="content">
                <div class="grid">
                    <div><label for="tipo">Tipo</label><input id="tipo" placeholder="Ex.: 60Ah / 12V"></div>
                    <div><label for="uso">Uso</label><input id="uso" placeholder="Ex.: Automotivo / Estacionário"></div>
                    <div><label for="numeroSerie">Número de Série</label><input id="numeroSerie" class="mono"
                            placeholder="Ex.: MRA-2025-0001"></div>
                    <div><label for="dataProducao">Data de Produção</label><input id="dataProducao" type="date"></div>
                    <div><label for="lote">Lote</label><input id="lote" class="mono" placeholder="Ex.: LOTE-AB12"></div>
                    <div><label for="index">ID (para atualizar)</label><input id="index" type="number" min="0"
                            placeholder="Ex.: 0" disabled></div>
                </div>

                <div class="checkbox-row">
                    <input type="checkbox" id="enableUpdate">
                    <label for="enableUpdate">Editar bateria existente</label>
                </div>

                <div class="actions">
                    <button id="btn-add" class="btn">Adicionar</button>
                    <button id="btn-update" class="btn secondary" disabled>Atualizar</button>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Buscar / Remover</h2>
            <div class="content">
                <div class="grid">
                    <div><label for="searchIndex">ID</label><input id="searchIndex" type="number" min="0"
                            placeholder="Ex.: 0"></div>
                </div>
                <div class="actions">
                    <button id="btn-fetch" class="btn ghost">Buscar</button>
                    <button id="btn-delete" class="btn ghost">Remover</button>
                </div>
                <div id="searchResult" class="result-box" style="display:none;"></div>
            </div>
        </section>

        <section class="card" style="grid-column: 1 / -1">
            <h2>Registros On-chain</h2>
            <div class="content">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Tipo</th>
                            <th>Uso</th>
                            <th>Número de Série</th>
                            <th>Data</th>
                            <th>Lote</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>Feito com ⚡ por você • <span id="net"></span></footer>
    <div id="toast" class="toast"></div>

    <script defer>
        document.addEventListener("DOMContentLoaded", async () => {
            const { ethers } = window;
            const ABI = [
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "_tipo",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_uso",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_numeroSerie",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_dataProducao",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_lote",
                            "type": "string"
                        }
                    ],
                    "name": "adicionarBateria",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "index",
                            "type": "uint256"
                        },
                        {
                            "internalType": "string",
                            "name": "_tipo",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_uso",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_numeroSerie",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_dataProducao",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "_lote",
                            "type": "string"
                        }
                    ],
                    "name": "atualizarBateria",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "index",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "numeroSerie",
                            "type": "string"
                        }
                    ],
                    "name": "BateriaAdicionada",
                    "type": "event"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "index",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "numeroSerie",
                            "type": "string"
                        }
                    ],
                    "name": "BateriaAtualizada",
                    "type": "event"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "index",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "numeroSerie",
                            "type": "string"
                        }
                    ],
                    "name": "BateriaRemovida",
                    "type": "event"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "index",
                            "type": "uint256"
                        }
                    ],
                    "name": "deletarBateria",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "index",
                            "type": "uint256"
                        }
                    ],
                    "name": "getBateria",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "tipo",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "uso",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "numeroSerie",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "dataProducao",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "lote",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "listar",
                    "outputs": [
                        {
                            "components": [
                                {
                                    "internalType": "string",
                                    "name": "tipo",
                                    "type": "string"
                                },
                                {
                                    "internalType": "string",
                                    "name": "uso",
                                    "type": "string"
                                },
                                {
                                    "internalType": "string",
                                    "name": "numeroSerie",
                                    "type": "string"
                                },
                                {
                                    "internalType": "string",
                                    "name": "dataProducao",
                                    "type": "string"
                                },
                                {
                                    "internalType": "string",
                                    "name": "lote",
                                    "type": "string"
                                },
                                {
                                    "internalType": "bool",
                                    "name": "ativo",
                                    "type": "bool"
                                }
                            ],
                            "internalType": "struct BateriasDefeituosas.Bateria[]",
                            "name": "",
                            "type": "tuple[]"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ];
            const CONTRACT_ADDRESS = "0x626B69Fa9A6DB4dF1ABb45867341ef0f25F501b8";
            const REQUIRED_CHAIN_ID = 421614;
            let provider, signer, contract;

            const $ = s => document.querySelector(s);
            const toast = (msg, kind = "ok") => {
                const el = $("#toast");
                el.className = `toast show ${kind}`;
                el.innerHTML = msg;
                setTimeout(() => el.classList.remove("show"), 3500);
            };

            async function connectWallet() {
                if (!window.ethereum) return toast("MetaMask não encontrada.", "err");
                await window.ethereum.request({ method: "eth_requestAccounts" });
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                const net = await provider.getNetwork();
                $("#net").textContent = `Rede: ${net.name || net.chainId}`;
                $("#btn-connect").style.display = "none";
                $("#wallet-info").style.display = "inline-block";
                toast("Carteira conectada.");
                refresh();
            }

            async function refresh() {
                try {
                    const list = await contract.listar();
                    const tbody = $("#tbody");
                    tbody.innerHTML = "";
                    list.forEach((b, i) => {
                        const status = b.ativo ? '<span class="chip ok">Ativo</span>' : '<span class="chip off">Removido</span>';
                        tbody.innerHTML += `<tr><td>${i}</td><td>${b.tipo}</td><td>${b.uso}</td><td>${b.numeroSerie}</td><td>${b.dataProducao}</td><td>${b.lote}</td><td>${status}</td></tr>`;
                    });
                } catch (err) { console.error(err); toast("Erro ao listar.", "err"); }
            }

            $("#btn-connect").addEventListener("click", connectWallet);

            $("#btn-add").addEventListener("click", async () => {
                try {
                    const tipo = $("#tipo").value, uso = $("#uso").value, ns = $("#numeroSerie").value, data = $("#dataProducao").value, lote = $("#lote").value;
                    const tx = await contract.adicionarBateria(tipo, uso, ns, data, lote);
                    toast("Adicionando...");
                    await tx.wait();
                    refresh();
                } catch (e) { console.error(e); toast("Erro ao adicionar.", "err"); }
            });

            $("#btn-update").addEventListener("click", async () => {
                try {
                    const i = $("#index").value, tipo = $("#tipo").value, uso = $("#uso").value, ns = $("#numeroSerie").value, data = $("#dataProducao").value, lote = $("#lote").value;
                    const tx = await contract.atualizarBateria(i, tipo, uso, ns, data, lote);
                    toast("Atualizando...");
                    await tx.wait();
                    refresh();
                } catch (e) { console.error(e); toast("Erro ao atualizar.", "err"); }
            });

            $("#btn-fetch").addEventListener("click", async () => {
                try {
                    const i = $("#searchIndex").value;
                    const b = await contract.getBateria(i);
                    $("#index").value = i;
                    $("#tipo").value = b.tipo; $("#uso").value = b.uso; $("#numeroSerie").value = b.numeroSerie; $("#dataProducao").value = b.dataProducao; $("#lote").value = b.lote;
                    $("#searchResult").style.display = "block";
                    $("#searchResult").innerHTML = `
          <b>ID:</b> ${i}<br>
          <b>Tipo:</b> ${b.tipo}<br>
          <b>Uso:</b> ${b.uso}<br>
          <b>Número de Série:</b> ${b.numeroSerie}<br>
          <b>Data de Produção:</b> ${b.dataProducao}<br>
          <b>Lote:</b> ${b.lote}
        `;
                    toast("Registro carregado para edição.");
                } catch (e) { console.error(e); toast("Erro ao buscar.", "err"); }
            });

            $("#btn-delete").addEventListener("click", async () => {
                try {
                    const i = $("#searchIndex").value;
                    const tx = await contract.deletarBateria(i);
                    toast("Removendo...");
                    await tx.wait();
                    $("#searchResult").style.display = "none";
                    refresh();
                } catch (e) { console.error(e); toast("Erro ao remover.", "err"); }
            });

            $("#enableUpdate").addEventListener("change", (e) => {
                const enabled = e.target.checked;
                $("#index").disabled = !enabled;
                $("#btn-update").disabled = !enabled;
            });

            if (window.ethereum) {
                window.ethereum.on("accountsChanged", () => location.reload());
                window.ethereum.on("chainChanged", () => location.reload());
            }
        });
    </script>
</body>

</html>